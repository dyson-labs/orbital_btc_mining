<!doctype html>
<html>
<head>
    <title>BTC Mining Satellite Configurator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: auto; }
        label { font-weight: bold; }
        .slider-label { margin-bottom: 4px; display: block; }
        .slider-value { display: inline-block; min-width: 40px; }
        #visuals, #textual { display: flex; flex-wrap: wrap; gap: 10px; }
        #visuals img { max-width: 320px; }
        #textual pre { background:#f5f5f5; padding:10px; margin:0; width:320px; }
    </style>
</head>
<body>
    <h1>Configure Your Satellite Mission</h1>
    <form id="configForm" onsubmit="return false;">
        <label for="orbit">Select Orbit:</label>
        <select id="orbit" name="orbit" onchange="updateOrbit()">
            {% for value, label in orbits %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <br><br>
        <label for="launch">Select Launch Vehicle:</label>
        <select id="launch" name="launch">
            {% for value, label in launches %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <br><br>
        <label for="sat_class">Select Satellite Class:</label>
        <select id="sat_class" name="sat_class">
            {% for value, label in sat_classes %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <br><br>
        <label for="comms_mode">Comms Uptime:</label>
        <select id="comms_mode" name="comms_mode" onchange="updateCommsMode()">
            <option value="ground">Ground Stations</option>
            <option value="relay">GEO/ISR Relay (100%)</option>
        </select>
        <br><br>
        <label for="gs_network">Ground Station Network:</label>
        <select id="gs_network" name="gs_network">
            {% for value, label in networks %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <br><br>
        <span class="slider-label">Bitcoin Price Appreciation (%/yr): <span id="btc_appreciation_val">0</span>%</span>
        <input type="range" id="btc_appreciation" name="btc_appreciation" min="-50" max="50" value="0" step="5" oninput="document.getElementById('btc_appreciation_val').innerText=this.value;">
        <br><br>
        <span class="slider-label">Bitcoin Network Hash Growth (%/yr): <span id="btc_hash_growth_val">0</span>%</span>
        <input type="range" id="btc_hash_growth" name="btc_hash_growth" min="-50" max="50" value="0" step="5" oninput="document.getElementById('btc_hash_growth_val').innerText=this.value;">
        <br><br>
        <span class="slider-label">Mission Lifetime (years): <span id="mission_life_val">5</span></span>
        <input type="range" id="mission_life" name="mission_life" min="0.25" max="10" value="5" step="0.25" oninput="document.getElementById('mission_life_val').innerText=this.value;">
        <br><br>
        <button type="button" onclick="simulate()">Simulate</button>
        <div id="loading" style="display:none; color: #0a0; font-weight: bold; margin: 20px 0;">
            Simulating... Please wait.
        </div>
    </form>
    <div id="results" style="margin-top: 2em; color: green;"></div>
    <div id="visuals" style="margin-top: 1em;">
        <img id="orbit_img" alt="Orbit plot" style="display:none;" />
        <img id="thermal_img" alt="Thermal plot" style="display:none;" />
        <img id="rf_plot_img" alt="RF Margin" style="display:none;" />
        <img id="roi_img" alt="ROI plot" style="display:none;" />
    </div>
    <div id="textual" style="margin-top:1em;">
        <pre id="rf_summary"></pre>
        <pre id="cost_breakdown"></pre>
        <pre id="spec_summary"></pre>
        <pre id="rad_summary"></pre>
    </div>
    <script>
        function formatValue(v) {
            if (typeof v === 'number') return v.toLocaleString();
            if (typeof v === 'string') {
                const m = v.match(/^(-?\d+(?:\.\d+)?)(.*)$/);
                if (m) {
                    const num = parseFloat(m[1]);
                    return num.toLocaleString(undefined, {maximumFractionDigits:2}) + m[2];
                }
            }
            return v;
        }

        function formatObject(obj) {
            return Object.entries(obj)
                .map(([k, v]) => k + ': ' + formatValue(v))
                .join('\n');
        }

        function updateCommsMode() {
            const mode = document.getElementById('comms_mode').value;
            const gs = document.getElementById('gs_network');
            if (mode === 'relay') {
                gs.disabled = true;
                gs.style.opacity = 0.5;
            } else {
                gs.disabled = false;
                gs.style.opacity = 1;
            }
            updateOrbit();
        }

        function updateOrbit() {
            const idx = document.getElementById('orbit').value;
            const comms = document.getElementById('comms_mode').value;
            fetch(`/orbit_visuals/${idx}?comms=${comms}`)
                .then(res => {
                    if (!res.ok) throw new Error('Server error ' + res.status);
                    return res.json();
                })
                .then(data => {
                    if (data.orbit_plot) {
                        document.getElementById('orbit_img').src =
                            'data:image/png;base64,' + data.orbit_plot;
                        document.getElementById('orbit_img').style.display = 'block';
                    }
                    if (data.thermal_plot) {
                        document.getElementById('thermal_img').src =
                            'data:image/png;base64,' + data.thermal_plot;
                        document.getElementById('thermal_img').style.display = 'block';
                    }
                    if (data.rf_plot) {
                        document.getElementById('rf_plot_img').src =
                            'data:image/png;base64,' + data.rf_plot;
                        document.getElementById('rf_plot_img').style.display = 'block';
                    }
                })
                .catch(e => {
                    document.getElementById('orbit_img').style.display = 'none';
                    document.getElementById('thermal_img').style.display = 'none';
                    document.getElementById('rf_plot_img').style.display = 'none';
                    console.error(e);
                });
        }

        function simulate() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').innerText = '';
            document.getElementById('orbit_img').style.display = 'none';
            document.getElementById('thermal_img').style.display = 'none';
            document.getElementById('rf_plot_img').style.display = 'none';
            document.getElementById('roi_img').style.display = 'none';
            document.getElementById('rf_summary').innerText = '';
            document.getElementById('cost_breakdown').innerText = '';
            document.getElementById('spec_summary').innerText = '';
            document.getElementById('rad_summary').innerText = '';
            const data = {
                orbit: document.getElementById('orbit').value,
                launch: document.getElementById('launch').value,
                sat_class: document.getElementById('sat_class').value,
                comms_mode: document.getElementById('comms_mode').value,
                gs_network: document.getElementById('gs_network').value,
                btc_appreciation: document.getElementById('btc_appreciation').value,
                btc_hash_growth: document.getElementById('btc_hash_growth').value,
                mission_life: document.getElementById('mission_life').value
            };
            fetch('/api/simulate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(res => {
                if (!res.ok) throw new Error('Server error ' + res.status);
                return res.json();
            })
            .then(res => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').innerText =
                    'Orbit: ' + res.orbit +
                    ' | Power: ' + res.power_w.toFixed(1) + ' W' +
                    ' | Mission Cost: $' + res.cost_summary.total_cost.toLocaleString();
                if (res.orbit_plot) {
                    document.getElementById('orbit_img').src = 'data:image/png;base64,' + res.orbit_plot;
                    document.getElementById('orbit_img').style.display = 'block';
                }
                if (res.thermal_plot) {
                    document.getElementById('thermal_img').src = 'data:image/png;base64,' + res.thermal_plot;
                    document.getElementById('thermal_img').style.display = 'block';
                }
                if (res.rf_plot) {
                    document.getElementById('rf_plot_img').src = 'data:image/png;base64,' + res.rf_plot;
                    document.getElementById('rf_plot_img').style.display = 'block';
                }
                if (res.roi_plot) {
                    document.getElementById('roi_img').src = 'data:image/png;base64,' + res.roi_plot;
                    document.getElementById('roi_img').style.display = 'block';
                }
                document.getElementById('rf_summary').innerText = formatObject(res.rf_summary);
                document.getElementById('cost_breakdown').innerText = formatObject(res.cost_summary);
                document.getElementById('spec_summary').innerText = formatObject(res.specs);
                document.getElementById('rad_summary').innerText = formatObject(res.radiation);
            })
            .catch(e => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').innerText = 'Error: ' + e;
            });
        }
        window.onload = function() {
            updateCommsMode();
            updateOrbit();
        };
    </script>
</body>
</html>
